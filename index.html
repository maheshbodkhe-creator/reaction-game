<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>React/or ‚Äî Reaction Timer</title>

  <!-- Typography: Oxanium for numbers/scores, Inter for UI text -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* ============================================================
       DESIGN TOKENS ‚Äî single source of truth for all visual values
       ============================================================ */
    :root {
      --bg:           #0F1117;
      --surface:      #1C1F2E;
      --surface-2:    #252840;
      --accent:       #6EE7B7;
      --accent-dim:   rgba(110,231,183,0.12);
      --accent-glow:  rgba(110,231,183,0.35);
      --danger:       #F87171;
      --danger-dim:   rgba(248,113,113,0.12);
      --text:         #F1F5F9;
      --muted:        #64748B;
      --border:       rgba(255,255,255,0.06);

      --font-display: 'Oxanium', monospace;
      --font-ui:      'Inter', sans-serif;

      --radius:       16px;
      --radius-sm:    8px;
      --transition:   0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ============================================================
       RESET & BASE
       ============================================================ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      overflow: hidden;
      /* Subtle grid background for depth */
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: center center;
    }

    /* ============================================================
       LAYOUT SHELL
       ============================================================ */
    .app {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* ============================================================
       HEADER
       ============================================================ */
    header {
      text-align: center;
    }

    .logo {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .logo span {
      color: var(--accent);
    }

    /* ============================================================
       SCORE STRIP ‚Äî shows round progress and current avg
       ============================================================ */
    .score-strip {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 1rem;
    }

    .stat { display: flex; flex-direction: column; gap: 2px; }
    .stat:last-child { align-items: flex-end; }

    .stat-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      transition: color var(--transition);
    }

    .stat-value.accent { color: var(--accent); }

    /* Round pips */
    .round-pips {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .pip {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      transition: background var(--transition), border-color var(--transition), transform var(--transition);
    }

    .pip.done       { background: var(--accent); border-color: var(--accent); }
    .pip.current    { background: transparent; border-color: var(--accent); transform: scale(1.3); }

    /* ============================================================
       MAIN ARENA ‚Äî the click target and feedback zone
       ============================================================ */
    .arena {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      cursor: pointer;
      /* Height: responsive but bounded */
      height: clamp(240px, 45vw, 340px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      border: 2px solid var(--border);
      background: var(--surface);
      transition:
        background var(--transition),
        border-color var(--transition),
        box-shadow 0.15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ---- State: idle (start screen) ---- */
    .arena[data-state="idle"] {
      background: var(--surface);
      border-color: var(--border);
      cursor: default;
    }

    /* ---- State: waiting (randomized delay, "get ready") ---- */
    .arena[data-state="waiting"] {
      background: var(--surface);
      border-color: var(--muted);
      cursor: wait;
      animation: pulse-wait 1.5s ease-in-out infinite;
    }

    @keyframes pulse-wait {
      0%, 100% { box-shadow: 0 0 0 0 rgba(100,116,139,0); }
      50%       { box-shadow: 0 0 0 12px rgba(100,116,139,0.12); }
    }

    /* ---- State: go (stimulus shown, waiting for tap) ---- */
    .arena[data-state="go"] {
      background: var(--accent-dim);
      border-color: var(--accent);
      box-shadow: 0 0 40px var(--accent-glow), inset 0 0 60px var(--accent-dim);
      cursor: crosshair;
      animation: flicker-in 0.08s ease;
    }

    @keyframes flicker-in {
      0%   { opacity: 0.3; }
      100% { opacity: 1; }
    }

    /* ---- State: result (round complete) ---- */
    .arena[data-state="result"] {
      background: var(--surface);
      border-color: var(--accent);
      cursor: pointer;
    }

    /* ---- State: early (clicked before stimulus) ---- */
    .arena[data-state="early"] {
      background: var(--danger-dim);
      border-color: var(--danger);
      box-shadow: 0 0 30px rgba(248,113,113,0.25);
      cursor: pointer;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%       { transform: translateX(-8px); }
      40%       { transform: translateX(8px); }
      60%       { transform: translateX(-5px); }
      80%       { transform: translateX(5px); }
    }

    /* ---- State: done (game over) ---- */
    .arena[data-state="done"] {
      background: var(--surface);
      border-color: var(--accent);
      cursor: default;
    }

    /* ============================================================
       ARENA INNER CONTENT
       ============================================================ */
    .arena-icon {
      font-size: 2.5rem;
      line-height: 1;
      transition: opacity var(--transition);
    }

    .arena-title {
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1;
      transition: color var(--transition);
    }

    .arena-subtitle {
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* ============================================================
       ROUND HISTORY TABLE
       ============================================================ */
    .history {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      min-height: 64px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-title {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .history-clear {
      background: none;
      border: none;
      color: var(--muted);
      font-family: var(--font-ui);
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .history-clear:hover { color: var(--danger); background: var(--danger-dim); }

    .history-rows {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      animation: slide-in 0.2s ease;
    }

    .history-row:last-child { border-bottom: none; }

    @keyframes slide-in {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .history-round {
      font-size: 0.65rem;
      color: var(--muted);
      width: 20px;
      flex-shrink: 0;
    }

    .history-bar-wrap {
      flex: 1;
      height: 4px;
      background: var(--surface-2);
      border-radius: 2px;
      overflow: hidden;
    }

    .history-bar {
      height: 100%;
      border-radius: 2px;
      background: var(--accent);
      transform-origin: left;
      animation: grow-bar 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes grow-bar {
      from { transform: scaleX(0); }
      to   { transform: scaleX(1); }
    }

    .history-ms {
      font-family: var(--font-display);
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 54px;
      text-align: right;
      color: var(--text);
    }

    .history-badge {
      font-size: 0.6rem;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 4px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      width: 36px;
      text-align: center;
      flex-shrink: 0;
    }

    .badge-best   { background: var(--accent-dim); color: var(--accent); }
    .badge-worst  { background: var(--danger-dim);  color: var(--danger); }
    .badge-blank  { visibility: hidden; }

    .empty-state {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      padding: 0.5rem 0;
    }

    /* ============================================================
       CTA BUTTON (start / play again)
       ============================================================ */
    .btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background var(--transition), transform 0.1s ease, box-shadow var(--transition);
      background: var(--accent);
      color: #0F1117;
    }

    .btn:hover  { background: #86efcd; box-shadow: 0 4px 20px var(--accent-glow); }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ============================================================
       FOOTER
       ============================================================ */
    footer {
      text-align: center;
      font-size: 0.65rem;
      color: var(--muted);
      letter-spacing: 0.05em;
    }

    /* ============================================================
       RESULT OVERLAY (shown inside arena on done state)
       ============================================================ */
    .arena-result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      width: 100%;
      padding: 0 2rem;
    }

    .result-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: center;
    }

    .result-stat-label {
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .result-stat-value {
      font-family: var(--font-display);
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--accent);
    }

    .result-stat-unit {
      font-size: 0.65rem;
      color: var(--muted);
    }

    /* ============================================================
       RESPONSIVE
       ============================================================ */
    @media (max-width: 380px) {
      .score-strip { padding: 0.75rem 1rem; }
      .stat-value  { font-size: 1.2rem; }
      .history     { padding: 0.75rem 1rem; }
    }
  </style>
</head>
<body>

<div class="app">

  <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header>
    <div class="logo">React<span>/</span>or</div>
  </header>

  <!-- ‚îÄ‚îÄ Score strip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="score-strip">
    <div class="stat">
      <span class="stat-label">Round</span>
      <span class="stat-value" id="roundDisplay">0 / 5</span>
    </div>

    <!-- Round pips (visual progress) -->
    <div class="round-pips" id="pips" aria-hidden="true"></div>

    <div class="stat">
      <span class="stat-label">Avg</span>
      <span class="stat-value" id="avgDisplay">‚Äî ms</span>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Arena (main interactive zone) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <!--
    The arena is the heart of the game. It has five data-states:
      idle     ‚Üí welcome screen, game hasn't started
      waiting  ‚Üí round started, random delay before stimulus
      go       ‚Üí stimulus shown ‚Äî user MUST click NOW
      early    ‚Üí user clicked before stimulus (penalty)
      result   ‚Üí round ended, showing this round's time
      done     ‚Üí all rounds complete, showing final results
  -->
  <div
    class="arena"
    id="arena"
    data-state="idle"
    role="button"
    tabindex="0"
    aria-label="Reaction arena"
  >
    <!-- Content is injected by JS based on current state -->
    <div class="arena-icon" id="arenaIcon">‚ö°</div>
    <div class="arena-title" id="arenaTitle">React/or</div>
    <div class="arena-subtitle" id="arenaSubtitle">Press Start to begin</div>
  </div>

  <!-- ‚îÄ‚îÄ Round history ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="history">
    <div class="history-header">
      <span class="history-title">Round History</span>
      <button class="history-clear" id="clearBtn" aria-label="Clear history">Clear</button>
    </div>
    <div class="history-rows" id="historyRows">
      <p class="empty-state" id="emptyState">No rounds yet</p>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CTA button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <button class="btn" id="mainBtn">Start Game</button>

  <footer>Click anywhere in the arena when it turns green &nbsp;¬∑&nbsp; 5 rounds per game</footer>

</div>

<script>
  /* ============================================================
     CONSTANTS & CONFIGURATION
     ============================================================ */
  const TOTAL_ROUNDS = 5;

  // Randomized delay range (ms). Wide range prevents anticipation.
  const DELAY_MIN = 1500;
  const DELAY_MAX = 4500;

  /* ============================================================
     STATE
     All mutable state lives in one object for clarity.
     ============================================================ */
  let state = {
    phase: 'idle',      // 'idle' | 'waiting' | 'go' | 'early' | 'result' | 'done'
    round: 0,           // current round (1-indexed, 0 = not started)
    times: [],          // reaction times in ms for each completed round
    stimulusAt: null,   // performance.now() timestamp when stimulus appeared
    delayTimer: null,   // timeout ID for the random pre-stimulus delay
    earlyTimer: null,   // timeout ID for clearing the 'early' state
  };

  /* ============================================================
     DOM REFS
     ============================================================ */
  const arena       = document.getElementById('arena');
  const arenaIcon   = document.getElementById('arenaIcon');
  const arenaTitle  = document.getElementById('arenaTitle');
  const arenaSub    = document.getElementById('arenaSubtitle');
  const roundDisp   = document.getElementById('roundDisplay');
  const avgDisp     = document.getElementById('avgDisplay');
  const pipsEl      = document.getElementById('pips');
  const historyRows = document.getElementById('historyRows');
  const emptyState  = document.getElementById('emptyState');
  const mainBtn     = document.getElementById('mainBtn');
  const clearBtn    = document.getElementById('clearBtn');

  /* ============================================================
     HELPERS
     ============================================================ */

  /** Clamp a number between min and max */
  const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

  /** Compute average of an array of numbers */
  const avg = arr => arr.length ? Math.round(arr.reduce((a, b) => a + b, 0) / arr.length) : null;

  /** Generate a random integer between min and max (inclusive) */
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  /** Determine bar width percentage relative to slowest time recorded */
  const barWidth = (ms, max) => `${clamp((ms / max) * 100, 4, 100)}%`;

  /* ============================================================
     RENDER ‚Äî keeps UI in sync with state
     ============================================================ */
  function render() {
    const { phase, round, times } = state;

    // ‚îÄ‚îÄ Arena state attr (drives all CSS state variants)
    arena.dataset.state = phase;

    // ‚îÄ‚îÄ Phase-specific arena content
    switch (phase) {
      case 'idle':
        arenaIcon.textContent  = '‚ö°';
        arenaTitle.textContent = 'React/or';
        arenaTitle.style.color = 'var(--text)';
        arenaSub.textContent   = 'Press Start to begin';
        arenaSub.style.color   = 'var(--muted)';
        break;

      case 'waiting':
        arenaIcon.textContent  = 'üëÅ';
        arenaTitle.textContent = 'Wait...';
        arenaTitle.style.color = 'var(--muted)';
        arenaSub.textContent   = 'Get ready ‚Äî click on green';
        arenaSub.style.color   = 'var(--muted)';
        break;

      case 'go':
        arenaIcon.textContent  = '‚óè';
        arenaTitle.textContent = 'NOW!';
        arenaTitle.style.color = 'var(--accent)';
        arenaSub.textContent   = 'Click / tap as fast as you can';
        arenaSub.style.color   = 'var(--accent)';
        break;

      case 'early':
        arenaIcon.textContent  = '‚úó';
        arenaTitle.textContent = 'Too Early!';
        arenaTitle.style.color = 'var(--danger)';
        arenaSub.textContent   = 'Wait for the green signal';
        arenaSub.style.color   = 'var(--danger)';
        break;

      case 'result': {
        const last = times[times.length - 1];
        arenaIcon.textContent  = '‚úì';
        arenaTitle.textContent = `${last} ms`;
        arenaTitle.style.color = 'var(--accent)';
        arenaSub.textContent   = round < TOTAL_ROUNDS
          ? 'Click to start next round'
          : 'Click to see results';
        arenaSub.style.color   = 'var(--muted)';
        break;
      }

      case 'done': {
        const best  = Math.min(...times);
        const worst = Math.max(...times);
        const mean  = avg(times);

        // Replace standard arena content with a mini-results grid
        arenaIcon.style.display = 'none';
        arenaTitle.style.display = 'none';
        arenaSub.style.display  = 'none';

        // Build results DOM (idempotent ‚Äî only if not already rendered)
        if (!arena.querySelector('.arena-result-grid')) {
          const grid = document.createElement('div');
          grid.className = 'arena-result-grid';
          grid.innerHTML = `
            <div class="result-stat">
              <span class="result-stat-label">Average</span>
              <span class="result-stat-value">${mean}</span>
              <span class="result-stat-unit">ms</span>
            </div>
            <div class="result-stat">
              <span class="result-stat-label">Best</span>
              <span class="result-stat-value">${best}</span>
              <span class="result-stat-unit">ms</span>
            </div>
            <div class="result-stat">
              <span class="result-stat-label">Worst</span>
              <span class="result-stat-value">${worst}</span>
              <span class="result-stat-unit">ms</span>
            </div>
            <div class="result-stat">
              <span class="result-stat-label">Rounds</span>
              <span class="result-stat-value">${TOTAL_ROUNDS}</span>
              <span class="result-stat-unit">completed</span>
            </div>
          `;
          arena.appendChild(grid);
        }
        break;
      }
    }

    // ‚îÄ‚îÄ Restore hidden elements if leaving 'done' state
    if (phase !== 'done') {
      arenaIcon.style.display  = '';
      arenaTitle.style.display = '';
      arenaSub.style.display   = '';
      const oldGrid = arena.querySelector('.arena-result-grid');
      if (oldGrid) oldGrid.remove();
    }

    // ‚îÄ‚îÄ Score strip
    roundDisp.textContent = `${round} / ${TOTAL_ROUNDS}`;
    const currentAvg = avg(times);
    avgDisp.textContent   = currentAvg !== null ? `${currentAvg} ms` : '‚Äî ms';
    avgDisp.classList.toggle('accent', currentAvg !== null);

    // ‚îÄ‚îÄ Pip indicators
    pipsEl.innerHTML = '';
    for (let i = 1; i <= TOTAL_ROUNDS; i++) {
      const pip = document.createElement('div');
      pip.className = 'pip';
      if (i < round || (i === round && phase === 'result'))  pip.classList.add('done');
      else if (i === round && phase !== 'idle')              pip.classList.add('current');
      pipsEl.appendChild(pip);
    }

    // ‚îÄ‚îÄ Main button label & enabled state
    mainBtn.disabled = ['waiting','go'].includes(phase);
    if (phase === 'idle' || phase === 'done') {
      mainBtn.textContent = phase === 'done' ? 'Play Again' : 'Start Game';
      mainBtn.style.display = '';
    } else {
      mainBtn.style.display = 'none';
    }

    // ‚îÄ‚îÄ History rows
    renderHistory();
  }

  /** Render the round history list with bar charts */
  function renderHistory() {
    const { times } = state;

    if (times.length === 0) {
      historyRows.innerHTML = '';
      emptyState.style.display = 'block';
      historyRows.appendChild(emptyState);
      return;
    }

    emptyState.style.display = 'none';

    const maxTime = Math.max(...times);
    const minIdx  = times.indexOf(Math.min(...times));
    const maxIdx  = times.indexOf(maxTime);

    // Build rows only for entries not yet rendered (performance opt)
    const existingCount = historyRows.querySelectorAll('.history-row').length;
    if (existingCount === times.length) return; // Nothing new to paint

    historyRows.innerHTML = ''; // Full repaint on any change (simple & reliable)

    times.forEach((ms, i) => {
      const isBest  = i === minIdx && times.length > 1;
      const isWorst = i === maxIdx && times.length > 1;

      const row = document.createElement('div');
      row.className = 'history-row';
      row.innerHTML = `
        <span class="history-round">${i + 1}</span>
        <div class="history-bar-wrap">
          <div class="history-bar" style="width:${barWidth(ms, maxTime)}"></div>
        </div>
        <span class="history-ms">${ms} ms</span>
        <span class="history-badge ${isBest ? 'badge-best' : isWorst ? 'badge-worst' : 'badge-blank'}">
          ${isBest ? 'Best' : isWorst ? 'Slow' : ''}
        </span>
      `;
      historyRows.appendChild(row);
    });
  }

  /* ============================================================
     GAME LOGIC
     ============================================================ */

  /** Begin a new round: start the random pre-stimulus delay */
  function startRound() {
    state.round++;
    state.phase = 'waiting';
    render();

    /*
      TIMING NOTE: We use a random delay between DELAY_MIN and DELAY_MAX ms.
      This prevents users from anticipating the stimulus based on rhythm.
      The actual "go" timestamp is captured via performance.now() ‚Äî a high-resolution
      timer with sub-millisecond precision ‚Äî rather than Date.now(), which can be
      affected by system clock adjustments.
    */
    state.delayTimer = setTimeout(() => {
      state.phase      = 'go';
      state.stimulusAt = performance.now(); // ‚Üê high-res timestamp
      render();
    }, randInt(DELAY_MIN, DELAY_MAX));
  }

  /**
   * Handle a click/tap on the arena.
   * The arena handles ALL game interaction; the Start button only initiates.
   */
  function handleArenaClick() {
    const { phase } = state;

    if (phase === 'waiting') {
      // Clicked before stimulus ‚Äî penalise and restart the round
      clearTimeout(state.delayTimer);
      state.phase = 'early';
      render();

      // After a brief pause, let user retry the same round
      state.earlyTimer = setTimeout(() => {
        // Back the round counter up so startRound() increments it correctly
        state.round--;
        startRound();
      }, 1500);
      return;
    }

    if (phase === 'go') {
      /*
        REACTION TIME MEASUREMENT:
        We capture performance.now() immediately on click and subtract the
        stored stimulusAt timestamp. performance.now() returns a DOMHighResTimeStamp
        with microsecond resolution, so we Math.round() to a clean ms integer.
      */
      const elapsed = Math.round(performance.now() - state.stimulusAt);
      state.times.push(elapsed);
      state.phase = 'result';
      render();
      return;
    }

    if (phase === 'result') {
      if (state.round < TOTAL_ROUNDS) {
        startRound();
      } else {
        state.phase = 'done';
        render();
      }
      return;
    }
  }

  /** Reset everything and return to idle */
  function resetGame() {
    clearTimeout(state.delayTimer);
    clearTimeout(state.earlyTimer);
    state = {
      phase: 'idle',
      round: 0,
      times: [],
      stimulusAt: null,
      delayTimer: null,
      earlyTimer: null,
    };
    render();
  }

  /* ============================================================
     EVENT LISTENERS
     ============================================================ */

  // Arena: click and keyboard (Enter/Space for accessibility)
  arena.addEventListener('click', handleArenaClick);
  arena.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      handleArenaClick();
    }
  });

  // Main CTA button
  mainBtn.addEventListener('click', () => {
    if (state.phase === 'idle' || state.phase === 'done') {
      resetGame();
      startRound();
    }
  });

  // Clear history button ‚Äî resets everything
  clearBtn.addEventListener('click', resetGame);

  /* ============================================================
     INIT
     ============================================================ */
  render();
</script>
</body>
</html>